{extend name="admin_layout"}

{block name="headerExtend"}
<style>
    .edittool {
        margin-top: 12px;
    }

    .panel-settting .panel-heading {
        background-color: #f5f5f5;
    }
</style>
{/block}


{block name="center-content"}
<div class="container-fluid">
    <div class="panel panel-default">
        <div class="panel-heading">写文章</div>
        <div class="panel-body row">
            <div class="col-md-8">
                <div class="form-group">
                    <label>标题</label>
                    <input id="post-title" type="text" class="form-control" placeholder="输入标题">
                </div>

                <label>正文</label>
                <div id="summernote"></div>
            </div>

            <div class="col-md-4">
                <div class="panel panel-default panel-settting">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            设置项
                        </h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label>分类：</label>
                            <select id="publish-cat" class="form-control">
                                {volist name='cates' id='cate'}
                                <option value="{$cate['cate_id']}">{$cate['cate_name']}
                                </option>
                                {/volist}
                            </select>
                        </div>

                        <div class="form-group">
                            <label>标签：</label>
                            <input id="publish-tags" type="text" class="form-control" placeholder="文章标签，使用逗号分隔">
                        </div>

                        <div class="form-group">
                            <label>发布时间：</label>
                            <input id="publish-time" type="datetime-local" class="form-control">
                        </div>


                        <div class="form-group">
                            <label>
                                <input id="publish-top" type="checkbox" value="true"> 置顶
                            </label>
                        </div>
                    </div>
                </div>

                <div style="margin-top:20px">
                    <div class="text-right edittool">
                        <button type="submit" class="btn btn-default" onclick="saveDraft()">保存草稿</button>
                        <button type="submit" class="btn btn-primary" onclick="publish()" style="margin-left: 2rem">
                            &nbsp;&nbsp;发&nbsp;&nbsp;表&nbsp;&nbsp;
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>
{/block}


{block name="footExtend"}
<script src="admin_js/summernote.min.js"></script>
<script src="admin_js/sumernote-zh.js"></script>
<script src="admin_js/site/notepad.js"></script>
<script src="admin_js/date.format.js"></script>

<script>
    function saveDraft() {
        sendAjax(1, $('#post-title').val(), $('#summernote').code(), $("#publish-cat option:selected").val(), false, $("#publish-tags").val(), toDate($("#publish-time").val()));
    }

    function publish() {
        var isTop = false;
        if ($("#publish-top").prop('checked')) {
            isTop = true;
        }
        sendAjax(0, $('#post-title').val(), $('#summernote').code(), $("#publish-cat option:selected").val(), isTop, $("#publish-tags").val(), toDate($("#publish-time").val()));
    }


    function sendAjax(status, title, content, cate, isTop, tags, postTime) {
        if (!title) {
            $.toast({text: "标题不能为空", position: 'mid-center', hideAfter: 800, allowToastClose: false,})
            return;
        }

        if (!content) {
            $.toast({text: "正文不能为空", position: 'mid-center', hideAfter: 800, allowToastClose: false,})
            return;
        }

        // console.log(status,title,content,cate)
        $.post(
            "/notepad/new",
            {status: status, title: title, content: content, cate: cate, isTop: isTop, tags: tags, postTime: postTime.getTime()},
            function (result) {
                if (result.code === 200) {
                    $.toast({text: "发表成功", position: 'mid-center', hideAfter: 800, allowToastClose: false,})
                    setTimeout("location.reload()", 800);
                }
            }
        );
    }

    var updatePublishTimer;

    $(function () {
        var time = $("#publish-time").attr("value");
        if (time === undefined) {
            updatePublishTime();
            updatePublishTimer = setInterval(updatePublishTime, 1000 * 30);
        }
    });

    function updatePublishTime() {
        var displayTime = $("#publish-time").attr("value");
        if (!displayTime) {
            $("#publish-time").attr("value", $.format.date(new Date(), "yyyy-MM-ddTHH:mm"));
            return;
        }

        var date = toDate(displayTime);
        if (new Date().getTime() - date.getTime() <= 1000 * 60 * 60) {
            $("#publish-time").attr("value", $.format.date(new Date(), "yyyy-MM-ddTHH:mm"));
        } else {
            if (updatePublishTimer) {
                clearInterval(updatePublishTimer);
            }
        }
    }


    var DATE_REGEXP = new RegExp("(\\d{4})-(\\d{2})-(\\d{2})(?:[T\\s])?(\\d{2}):(\\d{2})(?::(\\d{2})(?:.(\\d{3}))?)?");

    function toDate(dateString) {
        if (DATE_REGEXP.test(dateString)) {
            var timestamp = dateString.replace(DATE_REGEXP, function ($all, $year, $month, $day, $hour, $minute, $second, $milliscond) {
                var date = new Date($year, $month - 1, $day, $hour || "00", $minute || "00", $second || "00", $milliscond || "00");
                return date.getTime();
            });
            var date = new Date();
            date.setTime(timestamp);
            return date;
        }
        return null;
    }

</script>
{/block}